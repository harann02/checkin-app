<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>On-Site Check-In</title>
<style>
  :root {
    --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#64748b;
    --ok:#065f46; --warn:#92400e; --err:#991b1b; --line:#e5e7eb;
    --primary:#0ea5e9; --primary-weak:#dbeafe; --primary-text:#ffffff;
    --disabled:#94a3b8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:640px;margin:32px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:20px}
  h1{margin:0 0 8px;font-size:22px}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  label{display:block;font-size:13px;margin:12px 0 6px;color:#334155}
  input{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:10px;font-size:16px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .section{margin-top:16px;padding-top:16px;border-top:1px dashed var(--line)}
  .small{font-size:13px}
  button{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--primary);
    background:var(--primary);color:var(--primary-text);font-size:16px;cursor:pointer
  }
  button[disabled]{
    background:var(--primary-weak);border-color:var(--primary-weak);
    color:var(--disabled);cursor:not-allowed
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>On-Site Check-In</h1>

    <p id="status" class="muted">Requesting locationâ€¦</p>
    <p id="meta" class="small muted"></p>

    <form id="form" class="section" autocomplete="off">
      <div class="row">
        <div>
          <label for="employeeId">Employee ID</label>
          <input id="employeeId" required placeholder="e.g., OG1234" />
        </div>
        <div>
          <label for="name">Name</label>
          <input id="name" required placeholder="Full name" />
        </div>
      </div>
      <div style="margin-top:12px">
        <button id="checkinBtn" type="submit" disabled>Check In</button>
      </div>
      <p id="result" class="small"></p>
    </form>

    <p id="help" class="small muted section" style="display:none">
      If you donâ€™t see a location prompt, allow Location for this site in your browser
      (ðŸ”’ â†’ Site settings â†’ Location â†’ Allow) and reload. Check-ins are limited to phones with GPS.
    </p>
  </div>
</div>

<script>
  // ==== CONFIG ================================================================
  const SITE_NAME = 'Labuan Office';
  const SITE_LAT  = 5.284357953275637;
  const SITE_LNG  = 115.23158301414999;
  const RADIUS_M  = 2000;           // 2 km
  const MIN_ACCURACY_M = 200;       // require Â±200 m or better
  const REQUIRE_MOBILE  = true;     // only allow phones to check in

  // Google Apps Script backend (EXACT /exec URL + matching SECRET)
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyPEFnp5BJSBa7p1lG4_nOiZWyMfJjI7OwABXPk6AW4bEz2zonyO-ylH53kJB28f-6Q2A/exec';
  const SECRET   = 'Labu@n-2025-!';
  // ===========================================================================

  const $ = s => document.querySelector(s);
  const statusEl = $('#status'), metaEl = $('#meta'), helpEl = $('#help');
  const formEl = $('#form'), btn = $('#checkinBtn'), resultEl = $('#result');
  const idEl = $('#employeeId'), nameEl = $('#name');

  function haversineM(lat1, lon1, lat2, lon2){
    const R=6371000, toRad=d=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }
  const isMobileUA = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent||'');

  let lastFix = null;
  let withinOK = false;

  function updateButtonState(){
    const idFilled   = idEl.value.trim().length>0;
    const nameFilled = nameEl.value.trim().length>0;
    btn.disabled = !(withinOK && idFilled && nameFilled);
  }
  idEl.addEventListener('input', updateButtonState);
  nameEl.addEventListener('input', updateButtonState);

  function getFix(){
    return new Promise((res, rej)=>{
      if(!navigator.geolocation) return rej(new Error('Geolocation not supported by this browser.'));
      navigator.geolocation.getCurrentPosition(
        pos => res(pos),
        err => rej(err),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }

  // Optional: ping backend for quick diagnosis
  (async () => {
    if(!ENDPOINT) return;
    try {
      const r = await fetch(ENDPOINT, { method:'GET' }); // should return "OK"
      if (!r.ok) throw new Error('HTTP ' + r.status);
      console.log('Backend ping OK');
    } catch(e){ console.log('Backend ping failed:', e); }
  })();

  async function init(){
    try{
      statusEl.className='muted';
      statusEl.textContent='Requesting locationâ€¦';

      const pos = await getFix();
      const { latitude, longitude, accuracy } = pos.coords;
      lastFix = { lat: latitude, lng: longitude, accuracy };

      const distance = haversineM(latitude, longitude, SITE_LAT, SITE_LNG);
      const effectiveDistance = Math.max(0, distance - accuracy);
      let within = (effectiveDistance <= RADIUS_M) && (accuracy <= MIN_ACCURACY_M);

      if (REQUIRE_MOBILE && !isMobileUA()) within = false;

      metaEl.textContent =
        `${SITE_NAME} â€¢ radius ${RADIUS_M} m â€¢ you are ~${Math.round(distance)} m from center `
        + `(accuracy Â±${Math.round(accuracy)} m; effective ~${Math.round(effectiveDistance)} m).`;

      if(within){
        statusEl.className='ok';
        statusEl.textContent='On site âœ“';
        withinOK = true;
      }else{
        statusEl.className='warn';
        const reasons=[];
        if(accuracy>MIN_ACCURACY_M) reasons.push(`accuracy too poor (Â±${Math.round(accuracy)} m > ${MIN_ACCURACY_M} m)`);
        if(effectiveDistance>RADIUS_M) reasons.push(`outside geofence (~${Math.round(effectiveDistance)} m > ${RADIUS_M} m)`);
        if(REQUIRE_MOBILE && !isMobileUA()) reasons.push('mobile device required');
        statusEl.textContent = `Cannot check in: ${reasons.join('; ')}. Move closer and use your phone outdoors.`;
        withinOK = false;
      }
      updateButtonState();
    }catch(e){
      statusEl.className='err';
      statusEl.textContent = e.message.includes('denied')
        ? 'Location permission denied. Allow it in site settings and reload.'
        : 'Could not get your location. Step outside or enable GPS, then reload.';
      helpEl.style.display='block';
      withinOK = false;
      updateButtonState();
    }
  }

  document.addEventListener('DOMContentLoaded', init);

  formEl.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    updateButtonState();
    if(btn.disabled) return;

    btn.disabled = true;
    resultEl.className = 'small muted';
    resultEl.textContent = 'Submittingâ€¦';

    if(!ENDPOINT){
      resultEl.textContent = 'Checked in locally (no backend configured).';
      formEl.reset(); updateButtonState(); return btn.disabled=false;
    }

    const payload = {
      secret: SECRET,
      employeeId: idEl.value.trim(),
      name: nameEl.value.trim(),
      siteName: SITE_NAME,
      lat: lastFix?.lat, lng: lastFix?.lng, accuracy: lastFix?.accuracy,
      radiusM: RADIUS_M, userAgent: navigator.userAgent, note: ''
    };

    try{
      const r = await fetch(ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await r.json().catch(()=> ({}));
      if(json && json.ok){
        resultEl.className='small ok';
        resultEl.textContent = `Checked in at ${new Date().toLocaleString()} (server distanceâ‰ˆ${json.distanceM ?? 'n/a'} m).`;
        formEl.reset();
      }else{
        resultEl.className='small warn';
        resultEl.textContent = `Check-in failed: ${json.error || 'unknown_error'}`;
      }
    }catch(err){
      resultEl.className='small err';
      resultEl.textContent = `Network error: ${String(err)}`;
    }finally{
      updateButtonState();
    }
  });
</script>
</body>
</html>
