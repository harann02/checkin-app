<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>On-Site Check-In</title>
<style>
  :root { --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#64748b; --ok:#065f46; --warn:#92400e; --err:#991b1b; --line:#e5e7eb; }
  * { box-sizing:border-box }
  body { margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
  .wrap { max-width:560px; margin:48px auto; padding:0 16px }
  .card { background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:20px }
  h1 { margin:0 0 8px; font-size:22px }
  .muted{color:var(--muted)} .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  label{display:block;font-size:13px;margin:10px 0 6px;color:#334155}
  input,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px;background:#fff}
  button{cursor:pointer} button[disabled]{opacity:.6;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .section{margin-top:16px;padding-top:16px;border-top:1px dashed var(--line)}
  .small{font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>On-Site Check-In</h1>

    <p id="status" class="muted">Requesting locationâ€¦</p>
    <p id="meta" class="small muted"></p>

    <form id="form" class="section" autocomplete="off">
      <div class="row">
        <div>
          <label for="employeeId">Employee ID</label>
          <input id="employeeId" required placeholder="e.g., OG1234" />
        </div>
        <div>
          <label for="name">Name</label>
          <input id="name" required placeholder="Full name" />
        </div>
      </div>
      <button id="checkinBtn" type="submit" disabled>Check In</button>
      <p id="result" class="small"></p>
    </form>

    <p id="help" class="small muted section" style="display:none">
      If you donâ€™t see a location prompt, allow Location for this site in your browser
      (ðŸ”’ â†’ Site settings â†’ Location â†’ Allow) and reload. Check-ins must be done on a phone with GPS.
    </p>
  </div>
</div>

<script>
  // ==== CONFIG (edit if needed) ===============================================
  const SITE_NAME = 'Labuan Office';
  const SITE_LAT  = 5.284357953275637;        // Labuan Office latitude
  const SITE_LNG  = 115.23158301414999;       // Labuan Office longitude
  const RADIUS_M  = 2000;                     // 2 km geofence
  const MIN_ACCURACY_M = 200;                 // require Â±200 m or better
  const REQUIRE_MOBILE  = true;               // only allow phones to check in

  // Optional backend (Google Apps Script). Leave blank to skip logging.
  const ENDPOINT  = 'https://script.google.com/macros/s/AKfycbyPEFnp5BJSBa7p1lG4_nOiZWyMfJjI7OwABXPk6AW4bEz2zonyO-ylH53kJB28f-6Q2A/exec' ;   // e.g. https://script.google.com/macros/s/AKfycb.../exec
  const SECRET    = 'Labu@n-2025-!'; // must match Apps Script SECRET           
  // ============================================================================

  const $ = s => document.querySelector(s);
  const statusEl = $('#status'), metaEl = $('#meta'), helpEl = $('#help');
  const formEl = $('#form'), btn = $('#checkinBtn'), resultEl = $('#result');

  function haversineM(lat1, lon1, lat2, lon2) {
    const R=6371000, toRad=d=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }

  function isMobileUA() {
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
  }

  let lastFix = null;

  function getFix() {
    return new Promise((res, rej) => {
      if (!navigator.geolocation) return rej(new Error('Geolocation not supported by this browser.'));
      navigator.geolocation.getCurrentPosition(
        pos => res(pos),
        err => rej(err),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }

  async function init() {
    try {
      statusEl.className = 'muted';
      statusEl.textContent = 'Requesting locationâ€¦';
      const pos = await getFix();
      const { latitude, longitude, accuracy } = pos.coords;
      lastFix = { lat: latitude, lng: longitude, accuracy };

      const d = haversineM(latitude, longitude, SITE_LAT, SITE_LNG);
      // Conservative distance: subtract accuracy so fuzzy fixes can't sneak in
      const effectiveDistance = Math.max(0, d - accuracy);

      // Core eligibility
      let within = (effectiveDistance <= RADIUS_M) && (accuracy <= MIN_ACCURACY_M);

      // Optional: mobile-only check-ins
      if (REQUIRE_MOBILE && !isMobileUA()) within = false;

      // Explain what's happening
      metaEl.textContent =
        `${SITE_NAME} â€¢ radius ${RADIUS_M} m â€¢ you are ~${Math.round(d)} m from center `
        + `(accuracy Â±${Math.round(accuracy)} m; effective ~${Math.round(effectiveDistance)} m).`;

      if (within) {
        statusEl.className = 'ok';
        statusEl.textContent = 'On site âœ“';
        btn.disabled = false;
      } else {
        statusEl.className = 'warn';
        let reasons = [];
        if (accuracy > MIN_ACCURACY_M) reasons.push(`accuracy too poor (Â±${Math.round(accuracy)} m > ${MIN_ACCURACY_M} m)`);
        if (effectiveDistance > RADIUS_M) reasons.push(`outside geofence (~${Math.round(effectiveDistance)} m > ${RADIUS_M} m)`);
        if (REQUIRE_MOBILE && !isMobileUA()) reasons.push('mobile device required');
        statusEl.textContent = `Cannot check in: ${reasons.join('; ')}. Move closer and use your phone outdoors.`;
        btn.disabled = true;
      }
    } catch (e) {
      statusEl.className = 'err';
      statusEl.textContent = e.message.includes('denied')
        ? 'Location permission denied. Allow it in site settings and reload.'
        : 'Could not get your location. Step outside or enable GPS, then reload.';
      helpEl.style.display = 'block';
    }
  }

  document.addEventListener('DOMContentLoaded', init);

  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;

    if (!ENDPOINT) {
      // Local-only mode (no logging)
      resultEl.textContent = 'Checked in locally (no backend connected).';
      formEl.reset();
      btn.disabled = false;
      return;
    }

    const payload = {
      secret: SECRET,
      employeeId: $('#employeeId').value.trim(),
      name: $('#name').value.trim(),
      siteName: SITE_NAME,
      lat: lastFix?.lat, lng: lastFix?.lng, accuracy: lastFix?.accuracy,
      radiusM: RADIUS_M, userAgent: navigator.userAgent, note: ''
    };

    try {
      const r = await fetch(ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const json = await r.json().catch(()=> ({}));
      if (json.ok) {
        resultEl.textContent = `Checked in at ${new Date().toLocaleString()} (server distanceâ‰ˆ${json.distanceM ?? 'n/a'} m).`;
      } else {
        resultEl.textContent = `Check-in failed: ${json.error || 'unknown_error'}`;
      }
    } catch (err) {
      resultEl.textContent = `Network error: ${String(err)}`;
    } finally {
      formEl.reset();
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
