<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#0b9df0; --ok:#138a36; --bad:#c0362c; --text:#222; --muted:#6b7280; }
    *{box-sizing:border-box}
    body{margin:0;background:#f5f8fc;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .card{max-width:480px;margin:24px auto;background:#fff;border-radius:14px;padding:24px;
          box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .logo{width:130px;display:block;margin:0 auto 10px}
    h1{margin:6px 0 8px;text-align:center;color:var(--text)}
    #status{font-weight:700;text-align:center;margin:2px 0 8px}
    .meta{font-size:.92rem;color:#555;text-align:center;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:.9rem;color:#444}
    input, select{padding:12px;border:1px solid #d3d8e0;border-radius:10px;font-size:1rem}
    .btn{width:100%;padding:13px 16px;border:0;border-radius:12px;font-weight:700;
         color:#fff;background:var(--brand);cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-outline{background:#fff;color:var(--brand);border:2px solid var(--brand)}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
    .small{font-size:.95rem}
    .ok{color:var(--ok)}.err{color:var(--bad)}
    .muted{color:var(--muted)}
    .result{min-height:22px}
    .panel{margin-top:16px;border:1px solid #e6ebf2;border-radius:12px;padding:12px;background:#fafcff}
    .panel h3{margin:0 0 6px;font-size:1rem}
    .kv{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #e6ebf2}
    .kv:last-child{border-bottom:0}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8rem}
    .tag.ok{background:#e8f6ee;color:var(--ok);border:1px solid #bfe9cf}
    .tag.err{background:#fdecec;color:var(--bad);border:1px solid #f8c7c3}
    .footnote{margin-top:8px;font-size:.85rem}
  </style>
</head>
<body>
  <div class="card">
    <img class="logo" alt="CDSB" 
      src="https://ik.imagekit.io/f4l5qeepf/CDSB%20LOGO-V2.png?updatedAt=1759104698723" />
    <h1>Daily Attendance</h1>

    <div id="status" class="muted">Checking location…</div>
    <div id="meta" class="meta"></div>

    <div class="row">
      <div class="field">
        <label for="employeeId">Employee ID</label>
        <input id="employeeId" placeholder="e.g., CD111" autocomplete="off" />
      </div>

      <div class="field">
        <label for="name">Name</label>
        <input id="name" placeholder="Full name" autocomplete="name" />
      </div>

      <div class="field">
        <label for="site">Site Location</label>
        <select id="site">
          <option value="CDSB Office">CDSB Office</option>
          <option value="Lahad Datu Site">Lahad Datu Site</option>
          <option value="Sipitang Site">Sipitang Site</option>
        </select>
      </div>
    </div>

    <button id="checkinBtn" class="btn mt16" disabled>Check In</button>
    <button id="checkoutBtn" class="btn btn-outline mt8" disabled>Check Out</button>

    <div id="session" class="panel" style="display:none">
      <h3>Current Session</h3>
      <div class="kv"><span>Site</span><strong id="sessSite">—</strong></div>
      <div class="kv"><span>Clock In</span><strong id="sessIn">—</strong></div>
      <div class="kv" id="sessOutRow" style="display:none"><span>Clock Out</span><strong id="sessOut">—</strong></div>
      <div class="kv" id="sessDurRow" style="display:none"><span>Working Hours</span><strong id="sessDur">—</strong></div>
      <div class="footnote muted" id="withinFlag">Within radius: —</div>
    </div>

    <div id="result" class="small result mt12"></div>
  </div>

  <script>
    // Dynamic sites (TODO: update lat/lng for Lahad Datu & Sipitang)
    const SITES = {
      "CDSB Office": { name: "CDSB Office", lat: 5.284230328859213, lng: 115.23178272852763, radiusM: 2000 },
      "Lahad Datu Site": { name: "Lahad Datu Site", lat: 5.027785331868045, lng: 118.3610085876295, radiusM: 2000 },
      "Sipitang Site": { name: "Sipitang Site", lat: 5.011133282563158, lng: 115.50520715008498, radiusM: 2000 }
    };
    let SITE = SITES["CDSB Office"];
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbw8TVB01G7faS7_CUZJU99OS5xOlf5TvBVS0ZPuwgQzFjVEyiRLbOe1Iqy019B67c8aOQ/exec?v=B9";
    const SECRET = "Labu@n-2025-!";
    const REQUIRE_ONSITE_TO_CHECKOUT = false;

    const $ = s => document.querySelector(s);
    const statusEl = $("#status"), metaEl = $("#meta"), resultEl = $("#result");
    const inBtn = $("#checkinBtn"), outBtn = $("#checkoutBtn");
    const idEl = $("#employeeId"), nameEl = $("#name"), siteEl = $("#site");
    const sessWrap = $("#session"), sessSite=$("#sessSite"), sessIn=$("#sessIn"),
          sessOut=$("#sessOut"), sessOutRow=$("#sessOutRow"),
          sessDur=$("#sessDur"), sessDurRow=$("#sessDurRow"),
          withinFlag=$("#withinFlag");

    let current = null, within = false, watchId = null;

    function setSite(name){
      SITE = SITES[name] || SITES["CDSB Office"];
      if(current){ refreshGeoMeta(); }
    }
    function refreshGeoMeta(){
      const { lat, lng, accuracy } = current || {};
      if(lat == null) return;
      const dist = haversineM(lat, lng, SITE.lat, SITE.lng);
      const effective = Math.max(0, dist - accuracy);
      within = effective <= SITE.radiusM;
      statusEl.textContent = within ? "On site ✓" : "Outside geofence ✗";
      statusEl.className = within ? "ok" : "err";
      metaEl.textContent = `${SITE.name} • radius ${SITE.radiusM} m • you are ~${Math.round(dist)} m from center (accuracy ±${Math.round(accuracy)} m)`;
      withinFlag.textContent = `Within radius: ${within ? "True" : "False"}`;
      setButtons();
    }

    function haversineM(lat1, lon1, lat2, lon2){
      const R=6371000, toRad=d=>d*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function buster(url){return url+(url.includes("?")?"&":"?")+"t="+Date.now();}
    function pretty(d){ return new Date(d).toLocaleString(); }
    function ok(msg){ resultEl.className="small ok result"; resultEl.textContent=msg; }
    function err(msg){ resultEl.className="small err result"; resultEl.textContent=msg; }

    function loadProfile(){
      const savedId = localStorage.getItem("emp:id") || "";
      const savedName = localStorage.getItem("emp:name") || "";
      const savedSite = localStorage.getItem("emp:site") || "CDSB Office";
      idEl.value = savedId;
      nameEl.value = savedName;
      if(siteEl){ siteEl.value = savedSite; }
      setSite(savedSite);
    }
    function saveProfile(){
      localStorage.setItem("emp:id", idEl.value.trim());
      localStorage.setItem("emp:name", nameEl.value.trim());
      localStorage.setItem("emp:site", siteEl.value);
    }

    function loadSession(){
      const raw = localStorage.getItem("sess:open");
      if(!raw){ sessWrap.style.display="none"; outBtn.disabled = true; return; }
      try{
        const s = JSON.parse(raw);
        sessWrap.style.display="";
        sessSite.textContent = s.siteName || SITE.name;
        sessIn.textContent = pretty(s.clockIn);
        sessOutRow.style.display = s.clockOut ? "" : "none";
        sessDurRow.style.display = s.durationMin ? "" : "none";
        if(s.clockOut) sessOut.textContent = pretty(s.clockOut);
        if(s.durationMin){
          const h = (s.durationMin/60);
          sessDur.textContent = `${h.toFixed(2)} h (${Math.round(s.durationMin)} min)`;
        }
        const isOpen = !s.clockOut;
        inBtn.disabled = !within || !isOpen ? !within : true;
        outBtn.disabled = isOpen ? false : true;
      }catch(e){
        localStorage.removeItem("sess:open");
        sessWrap.style.display="none";
        outBtn.disabled = true;
      }
    }

    function openSession(siteName){
      const s = { siteName, clockIn: Date.now() };
      localStorage.setItem("sess:open", JSON.stringify(s));
      loadSession();
    }
    function closeSession(durationMin){
      const raw = localStorage.getItem("sess:open");
      if(!raw) return;
      const s = JSON.parse(raw);
      s.clockOut = Date.now();
      if(durationMin) s.durationMin = durationMin;
      localStorage.setItem("sess:open", JSON.stringify(s));
      loadSession();
    }

    function updateGeoUI(pos){
      const { latitude:lat, longitude:lng, accuracy } = pos.coords;
      current = { lat, lng, accuracy };

      const dist = haversineM(lat, lng, SITE.lat, SITE.lng);
      const effective = Math.max(0, dist - accuracy);
      within = effective <= SITE.radiusM;

      statusEl.textContent = within ? "On site ✓" : "Outside geofence ✗";
      statusEl.className = within ? "ok" : "err";
      metaEl.textContent = `${SITE.name} • radius ${SITE.radiusM} m • you are ~${Math.round(dist)} m from center (accuracy ±${Math.round(accuracy)} m)`;

      withinFlag.textContent = `Within radius: ${within ? "True" : "False"}`;
      setButtons();
    }

    function setButtons(){
      const hasId = !!idEl.value.trim();
      const hasName = !!nameEl.value.trim();
      const open = !!localStorage.getItem("sess:open") && !JSON.parse(localStorage.getItem("sess:open")).clockOut;
      inBtn.disabled = !(within && hasId && hasName && current);
      const onSiteGate = REQUIRE_ONSITE_TO_CHECKOUT ? within : true;
      outBtn.disabled = !(open && onSiteGate && hasId && hasName && current);
    }

    async function ping(){
      try{ await fetch(buster(ENDPOINT), { method:"GET" }); }
      catch(e){ err("Cannot reach server."); }
    }

    async function send(action){
      resultEl.textContent = "";
      const employeeId = idEl.value.trim().toUpperCase();
      const name = nameEl.value.trim();
      if(!employeeId || !name){ err("Enter ID and name."); return; }
      if(!current){ err("No location yet."); return; }
      if(action==="checkin" && !within){ err("You must be on-site to check in."); return; }
      if(action==="checkout" && REQUIRE_ONSITE_TO_CHECKOUT && !within){ err("You must be on-site to check out."); return; }
      saveProfile();

      const siteName = siteEl.value;
      const payload = {
        secret: SECRET, action,
        employeeId, name, siteName,
        lat: current.lat, lng: current.lng, accuracy: current.accuracy,
        radiusM: SITE.radiusM, userAgent: navigator.userAgent
      };

      try{
        const r = await fetch(buster(ENDPOINT), { method:"POST", body: JSON.stringify(payload) });
        const data = await r.json();
        if(data.ok){
          if(action==="checkin"){ openSession(siteEl.value); ok(`Checked in ✅  ${new Date().toLocaleString()}`); }
          else { closeSession(data.durationMin); ok(`Checked out ✅  ${new Date().toLocaleString()} (${data.durationMin||0} min)`); }
        } else err("Action failed: "+(data.error||"unknown"));
      }catch(e){ err("Network error: "+e.message); }
      finally{ setButtons(); }
    }

    inBtn.addEventListener("click", ()=>send("checkin"));
    outBtn.addEventListener("click", ()=>send("checkout"));
    idEl.addEventListener("input", setButtons);
    nameEl.addEventListener("input", setButtons);
    siteEl.addEventListener("change", ()=>{ saveProfile(); setSite(siteEl.value); });

    (function init(){
      loadProfile();
      loadSession();
      setButtons();
      if(siteEl && siteEl.value){ setSite(siteEl.value); }
      ping();
      if("geolocation" in navigator){
        watchId = navigator.geolocation.watchPosition(updateGeoUI, ()=>{statusEl.textContent="Location unavailable";statusEl.className="err";within=false;setButtons();},{enableHighAccuracy:true,timeout:15000,maximumAge:0});
      }else{
        statusEl.textContent = "Geolocation not supported";
        statusEl.className = "err";
      }
    })();
  </script>
</body>
</html>
