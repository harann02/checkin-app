<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>On-Site Check-In</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; }
    .card { max-width: 520px; margin: 0 auto; padding: 20px; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 1px 10px rgba(0,0,0,.05);}
    h1 { font-size: 20px; margin: 0 0 12px; }
    .muted { color: #6b7280; font-size: 14px; }
    .ok { color: #065f46; }
    .warn { color: #92400e; }
    .err { color: #991b1b; }
    label { display: block; font-size: 14px; margin: 12px 0 6px; }
    input, select, button, textarea {
      width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 16px;
    }
    button { cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hidden { display: none; }
    .badge { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; background:#eef2ff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>On-Site Check-In <span id="siteBadge" class="badge"></span></h1>
    <p id="status" class="muted">Requesting location…</p>

    <div id="preCheck" class="muted hidden">
      <p>We’ll verify you’re inside the approved area before enabling check-in.</p>
    </div>

    <form id="form" class="hidden" autocomplete="off">
      <div class="row">
        <div>
          <label for="employeeId">Employee ID</label>
          <input id="employeeId" placeholder="e.g. OG1234" required minlength="3" />
        </div>
        <div>
          <label for="name">Name</label>
          <input id="name" placeholder="Full name" required />
        </div>
      </div>

      <label for="note">Note (optional)</label>
      <textarea id="note" rows="2" placeholder="Optional remark (e.g., gate A)"></textarea>

      <button id="submitBtn" type="submit" disabled>Check In</button>
    </form>

    <div id="result" class="hidden"></div>
  </div>

  <script>
    // ===== CONFIG – EDIT THESE =====
    const CONFIG = {
      siteName: 'Labuan Yard',
      siteLat: 5.283000,
      siteLng: 115.230000,
      radiusM: 150,
      endpoint: 'PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE',
      secret: 'CHANGE_THIS_SECRET_TO_MATCH_GAS'
    };

    // ===== HELPERS =====
    const $ = sel => document.querySelector(sel);
    const statusEl = $('#status');
    const formEl = $('#form');
    const resultEl = $('#result');
    const submitBtn = $('#submitBtn');
    const preCheckEl = $('#preCheck');
    $('#siteBadge').textContent = CONFIG.siteName;

    function haversineM(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    // ===== GEOLOCATION & GEOFENCE =====
    let lastFix = null;

    function requestLocation() {
      if (!('geolocation' in navigator)) {
        statusEl.className = 'err';
        statusEl.textContent = 'This device does not support location.';
        return;
      }
      statusEl.textContent = 'Requesting GPS…';
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude, accuracy } = pos.coords;
          lastFix = { lat: latitude, lng: longitude, accuracy };
          const d = haversineM(latitude, longitude, CONFIG.siteLat, CONFIG.siteLng);
          const within = d <= CONFIG.radiusM;

          statusEl.className = within ? 'ok' : 'warn';
          statusEl.textContent = within
            ? `On site ✓ (≈${Math.round(d)} m from center, accuracy ±${Math.round(accuracy)} m)`
            : `Outside geofence (≈${Math.round(d)} m away). Move closer and refresh.`;

          if (within) {
            preCheckEl.classList.add('hidden');
            formEl.classList.remove('hidden');
            submitBtn.disabled = false;
          } else {
            preCheckEl.classList.remove('hidden');
            formEl.classList.add('hidden');
            submitBtn.disabled = true;
          }
        },
        err => {
          statusEl.className = 'err';
          statusEl.textContent = `Location error: ${err.message}`;
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    // Kick off immediately
    requestLocation();

    // ===== SUBMIT =====
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;

      const payload = {
        secret: CONFIG.secret,
        employeeId: $('#employeeId').value.trim(),
        name: $('#name').value.trim(),
        siteName: CONFIG.siteName,
        lat: lastFix?.lat,
        lng: lastFix?.lng,
        accuracy: lastFix?.accuracy,
        radiusM: CONFIG.radiusM,
        userAgent: navigator.userAgent,
        note: $('#note').value.trim()
      };

      // Basic client sanity check
      if (!payload.employeeId || !payload.name || !payload.lat || !payload.lng) {
        resultEl.className = 'err';
        resultEl.textContent = 'Missing required data.';
        resultEl.classList.remove('hidden');
        submitBtn.disabled = false;
        return;
      }

      try {
        const res = await fetch(CONFIG.endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await res.json().catch(() => ({}));
        if (json.ok) {
          resultEl.className = 'ok';
          const flag = json.withinRadius === false ? ' (server flagged OUTSIDE radius)' : '';
          resultEl.textContent = `Checked in successfully at ${new Date().toLocaleString()}${flag}. Distance≈${json.distanceM ?? 'n/a'} m`;
          resultEl.classList.remove('hidden');
          formEl.reset();
        } else {
          resultEl.className = 'err';
          resultEl.textContent = `Check-in failed: ${json.error || 'unknown_error'}`;
          resultEl.classList.remove('hidden');
        }
      } catch (e2) {
        resultEl.className = 'err';
        resultEl.textContent = `Network error: ${String(e2)}`;
        resultEl.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
