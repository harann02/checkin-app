<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#0b9df0; --ok:#138a36; --bad:#c0362c; --text:#222; }
    body{margin:0;background:#f5f8fc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .card{max-width:440px;margin:24px auto;background:#fff;border-radius:14px;padding:24px;
          box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .logo{width:130px;display:block;margin:0 auto 10px}
    h1{margin:6px 0 8px;text-align:center;color:var(--text)}
    #status{font-weight:700;text-align:center;margin:2px 0 10px}
    .meta{font-size:.92rem;color:#555;text-align:center;margin-bottom:16px}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    label{font-size:.9rem;color:#444;text-align:left}
    input{padding:12px;border:1px solid #d3d8e0;border-radius:10px;font-size:1rem}
    .btn{width:100%;padding:13px 16px;border:0;border-radius:12px;font-weight:700;
         color:#fff;background:var(--brand);cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-outline{background:#fff;color:var(--brand);border:2px solid var(--brand)}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
    .small{font-size:.95rem}
    .ok{color:var(--ok)}.err{color:var(--bad)}
    .result{min-height:22px} /* reserve space so layout doesn't jump */
  </style>
</head>
<body>
  <div class="card">
    <img class="logo" alt="CDSB" 
      src="https://ik.imagekit.io/f4l5qeepf/CDSB%20LOGO-V2.png?updatedAt=1759104698723" />
    <h1>Daily Attendance</h1>

    <div id="status">Checking location…</div>
    <div id="meta" class="meta"></div>

    <div class="field">
      <label for="employeeId">Employee ID</label>
      <input id="employeeId" placeholder="e.g., CD111" autocomplete="off" />
    </div>

    <div class="field">
      <label for="name">Name</label>
      <input id="name" placeholder="Full name" autocomplete="name" />
    </div>

    <button id="checkinBtn" class="btn mt16" disabled>Check In</button>
    <button id="checkoutBtn" class="btn btn-outline mt8">Check Out</button>

    <div id="result" class="small result mt12"></div>
  </div>

  <script>
    // ================== CONFIG ==================
    const SITE = { name: "Labuan Office", lat: 3.127928245717387, lng: 101.68323437585643, radiusM: 2000 };
    // IMPORTANT: paste your Apps Script Web App URL (the /exec link). Keep the v= tag.
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbw8TVB01G7faS7_CUZJU99OS5xOlf5TvBVS0ZPuwgQzFjVEyiRLbOe1Iqy019B67c8aOQ/exec?v=B9";
    const SECRET = "Labu@n-2025-!";
    const REQUIRE_ONSITE_TO_CHECKOUT = false; // set true if you want on-site only checkout

    // ================== HELPERS ==================
    const $ = s => document.querySelector(s);
    const statusEl = $("#status"), metaEl = $("#meta"), resultEl = $("#result");
    const inBtn = $("#checkinBtn"), outBtn = $("#checkoutBtn");
    const idEl = $("#employeeId"), nameEl = $("#name");
    let current = null, within = false;

    function haversineM(lat1, lon1, lat2, lon2){
      const R=6371000, toRad=d=>d*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function buster(url){return url+(url.includes("?")?"&":"?")+"t="+Date.now();}
    function nowText(){ return new Date().toLocaleString(); }

    async function ping(){
      try{
        const r = await fetch(buster(ENDPOINT), { method:"GET" });
        await r.text(); // just to ensure connectivity
      }catch(e){
        resultEl.className="small err";
        resultEl.textContent="Cannot reach server. Try different network / disable VPN.";
      }
    }

    // ================== GEO ==================
    function setUI(){
      inBtn.disabled = !within;
      if (REQUIRE_ONSITE_TO_CHECKOUT) outBtn.disabled = !within;
    }

    function onGeo(pos){
      const { latitude:lat, longitude:lng, accuracy } = pos.coords;
      current = { lat, lng, accuracy };

      const dist = haversineM(lat, lng, SITE.lat, SITE.lng);
      const effective = Math.max(0, dist - accuracy);
      within = effective <= SITE.radiusM;

      statusEl.textContent = within ? "On site ✓" : "Outside geofence ✗";
      statusEl.className = within ? "ok" : "err";
      metaEl.textContent =
        `${SITE.name} • radius ${SITE.radiusM} m • you are ~${Math.round(dist)} m from center `
        + `(accuracy ±${Math.round(accuracy)} m; effective ~${Math.round(effective)} m).`;

      setUI();
    }

    function onGeoErr(){
      statusEl.textContent = "Location unavailable";
      statusEl.className = "err";
      within=false; setUI();
    }

    // ================== SUBMITTERS ==================
    async function send(action){
      resultEl.textContent = "";
      const employeeId = idEl.value.trim(), name = nameEl.value.trim();
      if(!employeeId || !name){ resultEl.className="small err"; resultEl.textContent="Enter ID and name."; return; }
      if(!current){ resultEl.className="small err"; resultEl.textContent="No location yet."; return; }
      if(action==="checkin" && !within){ resultEl.className="small err"; resultEl.textContent="You must be on-site to check in."; return; }
      if(action==="checkout" && REQUIRE_ONSITE_TO_CHECKOUT && !within){ resultEl.className="small err"; resultEl.textContent="You must be on-site to check out."; return; }

      const payload = {
        secret: SECRET, action,
        employeeId, name, siteName: SITE.name,
        lat: current.lat, lng: current.lng, accuracy: current.accuracy,
        radiusM: SITE.radiusM, userAgent: navigator.userAgent
      };

      try{
        const r = await fetch(buster(ENDPOINT), { method:"POST", body: JSON.stringify(payload) }); // no headers → no preflight
        const data = await r.json();
        if(data.ok){
          resultEl.className = "small ok";
          if(action==="checkin"){
            resultEl.textContent = `Checked in ✅  ${nowText()}`;
          }else{
            const extra = data.durationMin ? ` (${data.durationMin} min)` : "";
            resultEl.textContent = `Checked out ✅  ${nowText()}${extra}`;
          }
        }else{
          resultEl.className="small err";
          resultEl.textContent="Action failed: "+(data.error||"unknown");
        }
      }catch(e){
        resultEl.className="small err";
        resultEl.textContent="Network error: "+e.message;
      }
    }

    inBtn.addEventListener("click", ()=>send("checkin"));
    outBtn.addEventListener("click", ()=>send("checkout"));

    // Init
    ping();
    navigator.geolocation.getCurrentPosition(onGeo, onGeoErr, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
  </script>
</body>
</html>
