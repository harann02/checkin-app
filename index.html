<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f8fc;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      margin-top: 30px;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 420px;
      width: 100%;
      text-align: center;
    }
    .logo {
      width: 120px;
      margin-bottom: 15px;
    }
    h1 {
      margin: 0;
      font-size: 1.6em;
      color: #222;
    }
    #status {
      margin-top: 8px;
      font-weight: bold;
    }
    .info {
      font-size: 0.9em;
      color: #555;
      margin: 10px 0 20px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }
    button {
      background: #0b9df0;
      color: #fff;
      padding: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 15px;
      font-size: 0.9em;
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Company Logo -->
    <img src="https://ik.imagekit.io/f4l5qeepf/CDSB%20LOGO-V2.png?updatedAt=1759104698723" alt="CDSB Logo" class="logo">

    <!-- Title -->
    <h1>Daily Attendance</h1>
    <div id="status">Checking location...</div>
    <div id="meta" class="info"></div>

    <!-- Form -->
    <form id="form">
      <input type="text" id="employeeId" placeholder="Employee ID" required>
      <input type="text" id="name" placeholder="Full Name" required>
      <button type="submit" id="checkinBtn" disabled>Check In</button>
    </form>

    <div id="result"></div>
  </div>

  <script>
    // CONFIG (edit if needed)
    const SITE_NAME = "Labuan Office";
    const SITE_LAT = 5.284357953275637;
    const SITE_LNG = 115.23158301414999;
    const RADIUS_M = 2000;
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbw8TVB01G7faS7_CUZJU99OS5xOlf5TvBVS0ZPuwgQzFjVEyiRLbOe1Iqy019B67c8aOQ/exec?v=B9"; // <-- paste Apps Script Web App URL here
    const SECRET = "Labu@n-2025-!";

    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");
    const btn = document.getElementById("checkinBtn");
    const form = document.getElementById("form");
    const resultEl = document.getElementById("result");

    let current = null;

    // Distance (haversine)
    function haversineM(lat1, lon1, lat2, lon2) {
      const R = 6371000, toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    // Get location
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude, accuracy } = pos.coords;
      current = { lat: latitude, lng: longitude, accuracy };

      const distance = haversineM(latitude, longitude, SITE_LAT, SITE_LNG);
      const effective = Math.max(0, distance - accuracy);
      const within = effective <= RADIUS_M;

      statusEl.textContent = within ? "On site ✓" : "Outside geofence ✗";
      statusEl.style.color = within ? "green" : "red";
      metaEl.textContent = `${SITE_NAME} • radius ${RADIUS_M} m • you are ~${Math.round(distance)} m from center (accuracy ±${Math.round(accuracy)} m; effective ~${Math.round(effective)} m).`;

      btn.disabled = !within;
    }, err => {
      statusEl.textContent = "Location unavailable";
      statusEl.style.color = "red";
    });

    // Handle submit
    form.addEventListener("submit", async e => {
      e.preventDefault();
      resultEl.textContent = "";

      const payload = {
        secret: SECRET,
        employeeId: document.getElementById("employeeId").value,
        name: document.getElementById("name").value,
        siteName: SITE_NAME,
        lat: current?.lat,
        lng: current?.lng,
        accuracy: current?.accuracy,
        userAgent: navigator.userAgent
      };

      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();
        if (data.ok) {
          resultEl.style.color = "green";
          resultEl.textContent = "Check-in successful!";
        } else {
          resultEl.style.color = "red";
          resultEl.textContent = "Check-in failed: " + data.error;
        }
      } catch (err) {
        resultEl.style.color = "red";
        resultEl.textContent = "Network error: " + err.message;
      }
    });
  </script>
</body>
</html>
